USE MASTER
GO
IF(EXISTS(SELECT *FROM SYSDATABASES WHERE NAME='QL_TourDuLich' ))
DROP DATABASE QL_TourDuLich
GO
CREATE DATABASE QL_TourDuLich;
GO
USE QL_TourDuLich;
GO

CREATE TABLE TOURDULICH (
    MaTour NVARCHAR(10) PRIMARY KEY,
    TenTour NVARCHAR(50) NOT NULL,
    SoNgay INT NOT NULL,
    SoDem INT NOT NULL,
    PT_Di NVARCHAR(20),
    PT_Ve NVARCHAR(20),
    GiaLe INT,
    GiaNhom INT
);

CREATE TABLE TINHTHANH (
    MaTTP NVARCHAR(10) PRIMARY KEY,
    TenTTP NVARCHAR(50) NOT NULL,
    Mien NVARCHAR(20)
);

CREATE TABLE DIEMDULICH (
    MaDDL NVARCHAR(10) PRIMARY KEY,
    TenDDL NVARCHAR(50) NOT NULL,
    DacTrung NVARCHAR(30),
    MaTTP NVARCHAR(10),
    FOREIGN KEY (MaTTP) REFERENCES TINHTHANH(MaTTP)
);

CREATE TABLE CT_TOUR_DIEMDL (
    MaTour NVARCHAR(10),
    MaDDL NVARCHAR(10),
    SoNgay INT,
    SoDem INT,
    PRIMARY KEY (MaTour, MaDDL),
    FOREIGN KEY (MaTour) REFERENCES TOURDULICH(MaTour),
    FOREIGN KEY (MaDDL) REFERENCES DIEMDULICH(MaDDL)
);

INSERT INTO TINHTHANH VALUES
('T01','Hà N?i','Mi?n B?c'),
('T02','Qu?ng Ninh','Mi?n B?c'),
('T03','Khánh Hòa','Mi?n Trung'),
('T04','TP.HCM','Mi?n Nam'),
('T05','Kiên Giang','Mi?n Nam');

INSERT INTO DIEMDULICH VALUES
('D01','V?nh H? Long','T?m bi?n','T02'),
('D02','Nha Trang','T?m bi?n','T03'),
('D03','Phú Qu?c','T?m bi?n','T05'),
('D04','Fansipan','Leo núi','T01'),
('D05','Bà Nà Hills','Tham quan','T03');

INSERT INTO TOURDULICH VALUES
('TR01','Tour H? Long 2N1D',2,1,'Ô tô','Ô tô',1500000,1800000),
('TR02','Tour Nha Trang 3N2D',3,2,'Máy bay','Máy bay',2500000,3000000),
('TR03','Tour Phú Qu?c 4N3D',4,3,'Máy bay','Ô tô',2800000,3200000),
('TR04','Tour Mi?n B?c 5N4D',5,4,'Ô tô','Ô tô',2000000,2500000),
('TR05','Tour Fansipan 3N2D',3,2,'Ô tô','Ô tô',1800000,2200000);

INSERT INTO CT_TOUR_DIEMDL VALUES
('TR01','D01',2,1),
('TR02','D02',3,2),
('TR03','D03',4,3),
('TR04','D01',1,1),
('TR04','D04',2,2),
('TR05','D04',3,2);

SELECT *FROM TINHTHANH;
SELECT *FROM DIEMDULICH;
SELECT *FROM TOURDULICH;
SELECT *FROM CT_TOUR_DIEMDL;

--a
SELECT MaTour, TenTour, PT_Di, PT_Ve, GiaNhom
FROM TOURDULICH
WHERE SoNgay = 2 AND SoDem = 1 AND GiaNhom < 2000000;
--b
SELECT  T.MaTour, T.TenTour
FROM TOURDULICH T
JOIN CT_TOUR_DIEMDL CT ON T.MaTour = CT.MaTour
JOIN DIEMDULICH D ON CT.MaDDL = D.MaDDL
WHERE PT_Di = 'Máy bay' AND PT_Ve = 'Ô tô' AND D.DacTrung = 'T?m bi?n'
ORDER BY GiaLe ASC;
--c
SELECT TOP 1 TT.TenTTP, COUNT(D.MaDDL) AS SoDiem
FROM TINHTHANH TT
JOIN DIEMDULICH D ON TT.MaTTP = D.MaTTP
GROUP BY TT.TenTTP
ORDER BY SoDiem DESC;
--d
SELECT TT.MaTTP, TT.TenTTP
FROM TINHTHANH TT
WHERE EXISTS (SELECT 1 FROM DIEMDULICH D WHERE D.MaTTP = TT.MaTTP AND D.DacTrung = 'T?m bi?n')
  AND EXISTS (SELECT 1 FROM DIEMDULICH D WHERE D.MaTTP = TT.MaTTP AND D.DacTrung = 'Leo núi');
--e
SELECT D.MaDDL, D.TenDDL
FROM DIEMDULICH D
WHERE NOT EXISTS (
    SELECT * FROM TOURDULICH T
    WHERE NOT EXISTS (
        SELECT * FROM CT_TOUR_DIEMDL CT
        WHERE CT.MaTour = T.MaTour AND CT.MaDDL = D.MaDDL
    )
);
--f
SELECT MaTour, TenTour, SoNgay, SoDem, GiaLe
FROM TOURDULICH
WHERE PT_Di = 'Máy bay' AND PT_Ve = 'Máy bay' AND GiaLe < 3000000;
--g
SELECT T.MaTour, T.TenTour, T.SoNgay, T.SoDem, T.GiaLe
FROM TOURDULICH T
JOIN CT_TOUR_DIEMDL CT ON T.MaTour = CT.MaTour
JOIN DIEMDULICH D ON CT.MaDDL = D.MaDDL
WHERE D.TenDDL = 'V?nh H? Long'
ORDER BY T.SoNgay DESC;
--h
SELECT TOP 1 T.TenTour, COUNT(CT.MaDDL) AS SoDiem
FROM TOURDULICH T
JOIN CT_TOUR_DIEMDL CT ON T.MaTour = CT.MaTour
GROUP BY T.TenTour
ORDER BY SoDiem DESC;
--i
SELECT DISTINCT TT.MaTTP, TT.TenTTP
FROM TINHTHANH TT
WHERE EXISTS (SELECT 1 FROM DIEMDULICH D WHERE D.MaTTP = TT.MaTTP AND D.DacTrung = 'T?m bi?n')
  AND NOT EXISTS (SELECT 1 FROM DIEMDULICH D WHERE D.MaTTP = TT.MaTTP AND D.DacTrung = 'Leo núi');
--j
SELECT T.MaTour, T.TenTour
FROM TOURDULICH T
WHERE NOT EXISTS (
    SELECT * FROM DIEMDULICH D
    JOIN TINHTHANH TT ON D.MaTTP = TT.MaTTP
    WHERE TT.Mien = 'Mi?n Nam'
    AND NOT EXISTS (
        SELECT * FROM CT_TOUR_DIEMDL CT
        WHERE CT.MaTour = T.MaTour AND CT.MaDDL = D.MaDDL
    )
);
